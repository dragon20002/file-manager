<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{layout/index}">

<th:block layout:fragment="css"></th:block>

<th:block layout:fragment="script">
<script>
	let dest = `api/mp4-files`;
	$.ajax({ method: "GET", url: dest }).done(function(data, textStatus, xhr) {
		if (xhr.status != 200) return;
		let fileInfos = data;

		let fileTableBody = $('#file-table').children('tbody');
		let idx = 0;
		fileInfos.forEach(fileInfo => {
			let extStartIdx = fileInfo.name.lastIndexOf('.');
			let noExtFileName = fileInfo.name.substring(0, extStartIdx);
			let imgSrc = encodeURI(`${fileInfo.rootDirName}/${noExtFileName}.png`);

			let tr = `
				<tr style="text-align: center">
					<td style="padding: 5px 5px 5px 5px">
						<img src="${imgSrc}" width="200px" alt="">
					</td>
					<td style="padding: 5px 5px 5px 5px">${fileInfo.rootDirName}</td>
					<td style="padding: 5px 5px 5px 5px">${fileInfo.name}</td>
					<td style="padding: 5px 5px 5px 5px">${fileInfo.size} KB</td>
					<td style="padding: 5px 5px 5px 5px">
						<a href="javascript:play('${idx}')"><i class="fas fa-play"></i></a>
					</td>
				</tr>
			`;
			fileTableBody.append(tr);
			idx++;
		});
	});

	const MP4_TNIL_COL = 0;
	const MP4_ROOT_COL = 1;
	const MP4_NAME_COL = 2;
	const MP4_SIZE_COL = 3;
	const MP4_PLAY_COL = 4;
	
	function play(idx) {
		let tr = $('#file-table').children('tbody').children('tr')[idx];
		let rootDirName = tr.children[MP4_ROOT_COL].innerText;  
		let fileName = tr.children[MP4_NAME_COL].innerText;

		let dest = encodeURI(`api/mp4-files/${rootDirName}/${fileName}`);
		$.ajax({ method: "GET", url: dest }).done(function(data, textStatus, xhr) {
			if (xhr.status != 200) return;
			let fileInfo = data;

			// view
			let mp3TableRows = $('#file-table').children('tbody').children('tr');
			mp3TableRows.each(function (idx, tr) {
				let trColor;
				let playIcon;
				if (tr.children[MP4_NAME_COL].innerText == fileName) {
					trColor = 'dodgerblue';
					playIcon = '';
				} else {
					trColor = 'black';
					playIcon = `<i class="fas fa-play"></i>`;
				}
				tr.style.color = trColor;
				tr.children[MP4_PLAY_COL].children[0].innerHTML = playIcon;
			});

			// title
			let videoName = $('#video-name');
			videoName.text(fileInfo.name);

			// video tag
			let video = $('#video');

			let videoSrc = encodeURI(`${fileInfo.rootDirName}/${fileInfo.name}`);
			video.find('source').attr('src', videoSrc);

			let trackSrc = videoSrc.substring(0, videoSrc.lastIndexOf('.')) + ".vtt";
			video.find('track').attr('src', trackSrc);

			video[0].load();
			video[0].play();
		});
	}

	function onVideoError(e) {
	  // video playback failed - show a message saying why
	  switch (e.target.error.code) {
	    case e.target.error.MEDIA_ERR_ABORTED:
	      alert('You aborted the video playback.');
	      break;
	    case e.target.error.MEDIA_ERR_NETWORK:
	      alert('A network error caused the video download to fail part-way.');
	      break;
	    case e.target.error.MEDIA_ERR_DECODE:
	      alert('The video playback was aborted due to a corruption problem or because the video used features your browser did not support.');
	      break;
	    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
	      alert('The video could not be loaded, either because the server or network failed or because the format is not supported.');
	      break;
	    default:
	      alert('An unknown error occurred.');
	      break;
	  }
	}

</script>
</th:block>

<div layout:fragment="content" class="container-fluid">
	<div style="height: 10px"></div>

	<h4 id="video-name"></h4>

	<hr>

	<video id="video" width="100%" controls onerror="onVideoError(event)">
		<source src="">
		<track label="Korean" kind="subtitles" srclang="ko" src="" default>
	</video>

	<hr>

	<h4>재생 목록</h4>

	<table id="file-table" class="table-responsive table-striped">
		<thead>
			<tr style="text-align: center"><th></th><th>그룹</th><th>파일명</th><th>크기</th><th></th>
		</thead>
		<tbody></tbody>
	</table>

</div>

</html>